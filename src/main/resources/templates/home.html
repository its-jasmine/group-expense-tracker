<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Divido | Home</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/main.css}"/>

    <style>

        .flex-row {
            display: flex;
            gap: 10px;
            align-items: stretch;
            justify-content: center;

        }


        /* Modal Styling*/
        .modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3); /* Semi-transparent black */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); /* For older webkit browsers*/

            display: none; /*change to flex to make visible*/
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px darkgray;
            width: 40%;
            padding: 20px;
            position: relative

        }
        .close-modal-btn {
            position: absolute;
            top: 5px;
            right: 5px;
        }


        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        /* Buttons */
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            display: inline-flex;
            background: var(--gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }


        /* Members Section */
        .members-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--light-purple);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .member-item:hover {
            background: #d4c5ff;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .balance {
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .balance.positive {
            background: #dcfce7;
            color: #166534;
        }

        .balance.negative {
            background: #fee2e2;
            color: #dc2626;
        }

        .balance.zero {
            background: #f3f4f6;
            color: var(--text-light);
        }


        /* Expenses Table */
        .expenses-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .expenses-table th,
        .expenses-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .expenses-table th {
            background: var(--light-purple);
            font-weight: 600;
            color: var(--dark-purple);
        }

        .expenses-table tr:hover {
            background: var(--bg-light);
        }

        .expense-amount {
            font-weight: 600;
            color: var(--primary-purple);
        }

    </style>
</head>
<body>
<header>
    <div class="header-content">
        <div class="logo">Divido</div>
        <div class="stats">
            <div class="stat-item">
                <h3 th:text="${memberCount}"></h3>
                <p>Members</p>
            </div>
            <div class="stat-item">
                <h3 th:text="|$${#numbers.formatDecimal(expenseSum,1,2)}|"></h3>
                <p>Total Expenses</p>
            </div>
            <div class="stat-item">
                <h3 th:text="${expenseCount}"></h3>
                <p>Transactions</p>
            </div>
        </div>
    </div>
</header>
<main>
    <section class="flex-row">
        <div id="members-card" class="card">
            <div class="card-header flex-row">
                <h2>Members</h2>
                <button class="btn-primary" onclick="showMemberModal()">Add Member</button>
            </div>
            <div class="members-list">

                <div th:if="${members}" th:each="member : ${members}" class="flex-row member-item">

                    <form class="flex-row" method="post" th:action="@{/members/edit}" >
                        <input type="hidden" th:value="${member.getId()}" name="id">
                        <p class="member-name" th:text="${member.getName()}"></p>
                        <input class="edit-text-input" hidden type="text" th:value="${member.getName()}" name="name" >
                        <button type="button" class="edit-member-btn">Edit</button>
                        <button hidden class="done-member-btn" type="submit">Done</button>
                    </form>

                    <form method="post" th:action="@{/members/delete}" >
                        <input type="hidden" th:value="${member.getId()}" name="id">
                        <button type="submit">Delete</button>
                    </form>

                </div>
            </div>
            <div class="modal-bg">
                <div class="modal-box">
                    <h1>Add new member</h1>
                    <button class="close-modal-btn" type="button">&times</button>
                    <form id="memberForm" method="post" th:action="@{/members/create}" th:object="${member}">
                        <label for="member-name">Name: </label>
                        <input id="member-name" type="text" th:field="*{name}">
                        <button type="submit">Add Member</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="expenses-card" class="card">
            <div class="card-header flex-row">
                <h2>Expenses</h2>
                <button class="btn-primary" onclick="showExpenseModal(this)">Add Expense</button>
            </div>
            <table class="expenses-table" th:if="${expenses}" >
                <thead>
                    <th>Expense</th>
                    <th>Amount</th>
                    <th>Currency</th>
                    <th>Paid By</th>
                    <th colspan="2">Actions</th>

                </thead>
                <tr th:if="${expenses}" th:each="expense : ${expenses}" >
                    <td th:text="${expense.getName()}"></td>
                    <td class="expense-amount" th:text="|$${#numbers.formatDecimal(expense.getAmount(),1,2)}|"></td>
                    <td th:text="${expense.getCurrency()}"></td>
                    <td th:text="${expense.getPaidBy().getName()}"></td>
                    <td>
                        <!-- Using server-side data attributes to be able to populate edit modal.
                        TODO As the amount of data increases, using a separate request to fetch this data may be better-->
                        <button onclick="showExpenseModal(this)"
                                th:data-id="${expense.id}"
                                th:data-name="${expense.name}"
                                th:data-amount="${expense.amount}"
                                th:data-currency="${expense.currency}"
                                th:data-paid-by="${expense.paidBy.getId()}">Edit</button>
                    </td>
                    <td>
                        <form method="post" th:action="@{/expenses/delete}" >
                            <input type="hidden" th:value="${expense.getId()}" name="id">
                            <button  class="edit-exp-btn" type="submit">Delete</button>
                        </form>
                    </td>
                </tr>

            </table>

        </div>
        <div class="modal-bg">
            <div class="modal-box">
                <h1>Add new expense</h1>
                <button class="close-modal-btn" type="button">&times</button>

                <form id="expenseForm" method="post" th:object="${expense}">
                    <!-- Add hidden field for expense ID -->
                    <input type="hidden" name="id">

                    <div>
                        <label for="exp-name">Name: </label>
                        <input id="exp-name" type="text" name="name" th:field="*{name}">
                    </div>
                    <div>
                        <label for="exp-amount">Amount: </label>
                        <input id="exp-amount" type="number" name="amount" th:field="*{amount}">
                    </div>
                    <div>
                        <label for="exp-currency">Currency: </label>
                        <select id="exp-currency" name="currency" th:field="*{currency}">
                            <option th:each="currency : ${currencies}" th:text="${currency}" th:value="${currency}"></option>
                        </select>
                    </div>

                    <div>
                        <label for="exp-paid-by">Paid By: </label>
                        <select id="exp-paid-by" name="paidBy" th:field="*{paidBy}">
                            <option th:each="member : ${members}" th:text="${member.name}" th:value="${member.getId()}"></option>
                        </select>
                    </div>
                    <!-- TODO allow selection of members involved in expense, for now we assume everyone is contributing to every expense -->

                    <button type="submit">Add Expense</button>
                </form>

            </div>
        </div>

    </section>
    <section>

        <div id="owings-card" class="card">
            <div class="card-header">
                <h2>Settlement Summary</h2>
                <div th:each="member : ${owings}" class="bordered-container">
                    <span>
                        <p th:each="owing : ${member.getValue()}" th:text="|${member.getKey().getName()} pays ${owing.key.getName()}: ${#numbers.formatCurrency(owing.value)}|"></p>
                    </span>
                </div>
            </div>
        </div>

    </section>
</main>
<footer>
    <p>Copyright &copy; 2025 Divido. All rights reserved.</p>
</footer>
</body>

<script>
    let editButtons = document.getElementsByClassName("edit-member-btn");
    for (let btn of editButtons){
        btn.addEventListener('click', enableMemberEdit)
    }

    let closeModalButtons = document.getElementsByClassName("close-modal-btn");
    for (let btn of closeModalButtons){
        btn.addEventListener('click', closeModal)
    }


    function showMemberModal(){
        const form = document.getElementById('memberForm');
        const modal = form.closest(".modal-bg")
        modal.style.display = "flex"; // make modal visible
    }

    function enableMemberEdit(e){
        const editButton = e.target;
        editButton.hidden = true;

        const form = editButton.parentElement;

        form.querySelector(".edit-text-input").hidden = false; // make text box visible
        form.querySelector(".member-name").hidden = true; // make name hidden
        form.querySelector(".done-member-btn").hidden = false; // make done button visible
    }

    function showExpenseModal(src){
        console.log("show expense modal")
        const expenseData = src.dataset;
        const form = document.getElementById('expenseForm');

        console.log('All expense data:', expenseData);
        console.log('Paid by value:', expenseData.paidBy);
        console.log('Paid by (with hyphen):', expenseData['paid-by']);

        // find modal that contains the form
        const modal = form.closest(".modal-bg")
        modal.style.display = "flex"; // make modal visible

        if (expenseData && expenseData.id) {
            // Edit mode
            form.elements['name'].value = expenseData.name || '';
            form.elements['amount'].value = expenseData.amount || '';
            form.elements['currency'].value = expenseData.currency || '';
            form.elements['paidBy'].value = expenseData.paidBy || '';
            form.elements['id'].value = expenseData.id;

            form.action = '/expenses/edit';
            form.querySelector('button[type="submit"]').textContent = 'Update Expense';
        } else {
            // Add mode
            form.reset();
            form.action = '/expenses/create';
            form.querySelector('button[type="submit"]').textContent = 'Add Expense';
        }
    }
    function closeModal(e){
        console.log("close expense modal")
        e.target.closest(".modal-bg").style.display = "none"; // hide modal
    }

</script>
</html>