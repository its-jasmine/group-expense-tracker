<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Divido | Home</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/main.css}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>

        .flex-row {
            display: flex;
            gap: 10px;
            align-items: stretch;
            justify-content: center;

        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }


        /* Modal Styling*/
        .modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3); /* Semi-transparent black */
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(10px); /* For older webkit browsers*/

            display: none; /*change to flex to make visible*/
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            padding: 20px;
            position: relative

        }
        .close-modal-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal-btn:hover {
            background: var(--bg-light);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-purple);
        }

        /* Buttons */
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            display: inline-flex;
            background: var(--gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }
        .action-btn {
            color: var(--text-light);
            padding: 10px 15px;
        }

        .action-btn:hover {
            background: var(--bg-light);
        }



        /* Members Section */
        .members-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--light-purple);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .member-item:hover {
            background: #d4c5ff;
        }
        .member-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /*


        .balance {
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .balance.positive {
            background: #dcfce7;
            color: #166534;
        }

        .balance.negative {
            background: #fee2e2;
            color: #dc2626;
        }

        .balance.zero {
            background: #f3f4f6;
            color: var(--text-light);
        }*/


        /* Expenses Table */
        .expenses-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .expenses-table th,
        .expenses-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .expenses-table th {
            background: var(--light-purple);
            font-weight: 600;
            color: var(--dark-purple);
        }

        .expenses-table tr:hover {
            background: var(--bg-light);
        }

        .expense-amount {
            font-weight: 600;
            color: var(--primary-purple);
        }

    </style>
</head>
<body>
<header>
    <div class="header-content">
        <div class="logo">Divido</div>
        <div class="stats">
            <div class="stat-item">
                <h3 th:text="${memberCount}"></h3>
                <p>Members</p>
            </div>
            <div class="stat-item">
                <h3 th:text="|$${#numbers.formatDecimal(expenseSum,1,2)}|"></h3>
                <p>Total Expenses</p>
            </div>
            <div class="stat-item">
                <h3 th:text="${expenseCount}"></h3>
                <p>Transactions</p>
            </div>
        </div>
    </div>
</header>
<main>
    <section class="flex-row">
        <div id="members-card" class="card">
            <div class="card-header flex-row">
                <h2>Members</h2>
                <button class="btn-primary" onclick="showMemberModal(this)">Add Member</button>
            </div>
            <div class="members-list">

                <div th:if="${members}" th:each="member : ${members}" class="member-item">
                    <div class="member-info">
                        <div class="member-avatar" th:text="${member.getName().charAt(0)}"></div>
                        <p class="member-name" th:text="${member.getName()}"></p>
                    </div>

                    <button type="button" class="action-btn" onclick="showMemberModal(this)"
                            th:data-id="${member.getId()}"
                            th:data-name="${member.getName()}">
                        <i class="fa fa-pencil"></i>
                    </button>

                    <form method="post" th:action="@{/members/delete}" >
                        <input type="hidden" th:value="${member.getId()}" name="id">
                        <button class="action-btn" type="submit"><i class="fa fa-trash-o"></i></button>
                    </form>

                </div>
            </div>
            <div class="modal-bg">
                <div class="modal-box">
                    <h1>Add New Member</h1>
                    <button class="close-modal-btn" type="button">&times</button>
                    <form id="memberForm" method="post" th:object="${member}">
                        <div class="form-group">
                            <input type="hidden" name="id">
                            <label for="name">Name: </label>
                            <input id="name" type="text" th:field="*{name}">
                        </div>
                        <button type="submit">Add Member</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="expenses-card" class="card">
            <div class="card-header flex-row">
                <h2>Expenses</h2>
                <button class="btn-primary" onclick="showExpenseModal(this)">Add Expense</button>
            </div>
            <table class="expenses-table" th:if="${expenses}" >
                <thead>
                <th>Expense</th>
                <th>Amount</th>
                <th>Currency</th>
                <th>Paid By</th>
                <th>Category</th>
                <th></th>
                <th colspan="2" style="text-align: center">Actions</th>

                </thead>
                <tr th:if="${expenses}" th:each="expense : ${expenses}" >
                    <td th:text="${expense.getName()}"></td>
                    <td class="expense-amount" th:text="|$${#numbers.formatDecimal(expense.getAmount(),1,2)}|"></td>
                    <td th:text="${expense.getCurrency()}"></td>
                    <td th:text="${expense.getPaidBy().getName()}"></td>
                    <td th:text="${expense.getCategory().name()}"></td>
                    <td>
                        <!-- Using server-side data attributes to be able to populate edit modal.
                        TODO As the amount of data increases, using a separate request to fetch this data may be better-->
                        <button class="action-btn"  onclick="showExpenseModal(this)"
                                th:data-id="${expense.id}"
                                th:data-name="${expense.name}"
                                th:data-amount="${expense.amount}"
                                th:data-currency="${expense.currency}"
                                th:data-paid-by="${expense.paidBy.getId()}"
                                th:data-category="${expense.getCategory().name()}">
                            <i class="fa fa-pencil"></i></button>
                    </td>
                    <td>
                        <form method="post" th:action="@{/expenses/delete}" >
                            <input type="hidden" th:value="${expense.getId()}" name="id">
                            <button class="action-btn" type="submit"><i class="fa fa-trash-o"></i></button>
                        </form>
                    </td>
                </tr>

            </table>

        </div>
        <div class="modal-bg">
            <div class="modal-box">
                <h1>Add New Expense</h1>
                <button class="close-modal-btn" type="button">&times</button>

                <form id="expenseForm" method="post" th:object="${expense}">
                    <!-- Add hidden field for expense ID -->
                    <input type="hidden" name="id">

                    <div class="form-group">
                        <label for="exp-name">Name: </label>
                        <input id="exp-name" type="text" name="name" th:field="*{name}">
                    </div>
                    <div class="form-group">
                        <label for="exp-amount">Amount: </label>
                        <input id="exp-amount" type="number" name="amount" th:field="*{amount}">
                    </div>
                    <div class="form-group">
                        <label for="exp-currency">Currency: </label>
                        <select id="exp-currency" name="currency" th:field="*{currency}">
                            <option th:each="currency : ${currencies}" th:text="${currency}" th:value="${currency}"></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="exp-category">Category: </label>
                        <select id="exp-category" name="currency" th:field="*{category}">
                            <option th:each="category : ${categories}" th:text="${category}" th:value="${category}"></option>
                        </select>
                    </div>


                    <div class="form-group">
                        <label for="exp-paid-by">Paid By: </label>
                        <select id="exp-paid-by" name="paidBy" th:field="*{paidBy}">
                            <option th:each="member : ${members}" th:text="${member.name}" th:value="${member.getId()}"></option>
                        </select>
                    </div>
                    <!-- TODO allow selection of members involved in expense, for now we assume everyone is contributing to every expense -->

                    <button type="submit">Add Expense</button>
                </form>

            </div>
        </div>

    </section>
    <section>

        <div id="owings-card" class="card">
            <div class="card-header">
                <h2>Settlement Summary</h2>
                <div th:each="member : ${owings}" class="bordered-container">
                    <span>
                        <p th:each="owing : ${member.getValue()}" th:text="|${member.getKey().getName()} pays ${owing.key.getName()}: ${#numbers.formatCurrency(owing.value)}|"></p>
                    </span>
                </div>
            </div>
        </div>

    </section>
</main>
<footer>
    <p>Copyright &copy; 2025 Divido. All rights reserved.</p>
</footer>
</body>

<script>
    let closeModalButtons = document.getElementsByClassName("close-modal-btn");
    for (let btn of closeModalButtons){
        btn.addEventListener('click', closeModal)
    }

    const MODAL_CONFIGS = {
        member: {
            formId: 'memberForm',
            fields: ['name'],
            actions: { edit: '/members/edit', create: '/members/create' },
            text: {
                editTitle: 'Edit Member',
                addTitle: 'Add New Member',
                editButton: 'Update Member',
                addButton: 'Add Member'
            }
        },
        expense: {
            formId: 'expenseForm',
            fields: ['name', 'amount', 'currency', 'paidBy'],
            actions: { edit: '/expenses/edit', create: '/expenses/create' },
            text: {
                editTitle: 'Edit Expense',
                addTitle: 'Add New Expense',
                editButton: 'Update Expense',
                addButton: 'Add Expense'
            }
        }
    };

    function showModal(src, config){
        const data = src.dataset;
        const form = document.getElementById(config.formId);

        // find modal that contains the form
        const modal = form.closest(".modal-bg")
        modal.style.display = "flex"; // make modal visible

        if (data && data.id) { // Edit mode
            form.elements["id"].value = data.id;
            config.fields.forEach(field => {
                if (form.elements[field]) {
                    form.elements[field].value = data[field] || "" ;
                } else {
                    console.log("Unable to populate field: " + field);
                }
            })

            form.action = config.actions.edit;
            modal.querySelector("h1").textContent = config.text.editTitle;
            form.querySelector('button[type="submit"]').textContent = config.text.editButton;
        } else { // Add mode
            form.reset();
            form.action = config.actions.create;
            modal.querySelector("h1").textContent =  config.text.addTitle;
            form.querySelector('button[type="submit"]').textContent =  config.text.addButton;
        }


    }


    function showMemberModal(src){
        showModal(src,MODAL_CONFIGS.member);
    }

    function showExpenseModal(src){
        showModal(src,MODAL_CONFIGS.expense);
    }
    function closeModal(e){
        console.log("close expense modal")
        e.target.closest(".modal-bg").style.display = "none"; // hide modal
    }

</script>
</html>